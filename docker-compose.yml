version: '3.8'

# Base configuration - Use with environment-specific overrides
# Usage: docker-compose --env-file config/.env.dev up -d
#        docker-compose --env-file config/.env.prod up -d

services:
  # PocketBase - Authentication & Database
  pocketbase:
    image: ${POCKETBASE_IMAGE:-ghcr.io/muchobien/pocketbase:latest}
    container_name: ${POCKETBASE_CONTAINER_NAME:-framer-pocketbase}
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${POCKETBASE_PORT:-8090}:8090"
    volumes:
      - pocketbase_data:/pb_data
      - ./pocketbase/pb_migrations:/pb_migrations
    environment:
      - ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL:-}
      - ADMIN_PASSWORD=${POCKETBASE_ADMIN_PASSWORD:-}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/api/health"]
      interval: ${HEALTHCHECK_INTERVAL:-10s}
      timeout: ${HEALTHCHECK_TIMEOUT:-5s}
      retries: ${HEALTHCHECK_RETRIES:-5}

  # FastAPI Backend
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: ${BACKEND_CONTAINER_NAME:-framer-backend}
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    environment:
      - POCKETBASE_URL=${POCKETBASE_INTERNAL_URL:-http://pocketbase:8090}
      - DATA_PATH=${BACKEND_DATA_PATH:-/data}
      - LOG_LEVEL=${BACKEND_LOG_LEVEL:-info}
      - CORS_ORIGINS=${BACKEND_CORS_ORIGINS:-http://localhost:3000}
      - DEBUG=${DEBUG:-false}
      # AI Configuration
      - AI_CONFIG_PATH=/data/ai.yaml
      - AI_PROVIDER=${AI_PROVIDER:-}
      - AI_MODEL=${AI_MODEL:-}
      - AI_API_KEY=${AI_API_KEY:-}
      - AI_ENDPOINT=${AI_ENDPOINT:-}
      - AI_TEMPERATURE=${AI_TEMPERATURE:-}
      - AI_MAX_TOKENS=${AI_MAX_TOKENS:-}
      - AI_TIMEOUT=${AI_TIMEOUT:-}
      - AI_SSL_VERIFY=${AI_SSL_VERIFY:-}
    volumes:
      - backend_data:/data
      - ./config:/config:ro
      - ./data/templates:/data/templates:ro
    depends_on:
      pocketbase:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/docs')"]
      interval: ${HEALTHCHECK_INTERVAL:-10s}
      timeout: ${HEALTHCHECK_TIMEOUT:-5s}
      retries: ${HEALTHCHECK_RETRIES:-5}

  # Next.js Frontend
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8000}
        - NEXT_PUBLIC_POCKETBASE_URL=${NEXT_PUBLIC_POCKETBASE_URL:-http://localhost:8090}
    container_name: ${FRONTEND_CONTAINER_NAME:-framer-frontend}
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8000}
      - NEXT_PUBLIC_POCKETBASE_URL=${NEXT_PUBLIC_POCKETBASE_URL:-http://localhost:8090}
      - NEXT_PUBLIC_API_TIMEOUT=${NEXT_PUBLIC_API_TIMEOUT:-30000}
      - NODE_ENV=${NODE_ENV:-production}
    depends_on:
      - backend

volumes:
  pocketbase_data:
  backend_data:
